@model Municipal_services_app.Models.EventsIndexViewModel

<div class="container mt-3">
    <img src="~/svg/city-of-cape-town-seeklogo.svg" alt="Municipality Logo" class="me-2" style="height: 200px; width: auto;">

    <!-- Hidden form just to render the antiforgery token for AJAX POSTs -->
    <form id="antiForgeryForm" method="post" style="display:none;" asp-controller="Event" asp-action="RecordSearch">
        @Html.AntiForgeryToken()
    </form>

    <!-- Toggle Tabs -->
    <div class="d-flex justify-content-center mb-4">
        <button id="btn-events" class="tab-btn active">
            Events <span class="badge badge-count">@Model.Events.Count</span>
        </button>
        <button id="btn-announcements" class="tab-btn">
            Announcements <span class="badge badge-count">@Model.Announcements.Count</span>
        </button>
    </div>

    <!-- Search + Filters Horizontal -->
    <form id="searchForm" method="get" asp-action="Load" class="mb-4">
        <div id="filters-section" class="d-flex flex-wrap gap-2 align-items-center">
            <input type="text" id="searchInput" name="q" class="form-control flex-grow-1" placeholder="Search events..." value="@Model.Query" />

            <select id="categorySelect" name="category" class="form-select">
                <option value="">All Categories</option>
                @foreach (var cat in Model.Categories)
                {
                    if (Model.SelectedCategory == cat)
                    {
                        <option value="@cat" selected>@cat</option>
                    }
                    else
                    {
                        <option value="@cat">@cat</option>
                    }
                }
            </select>

            <input type="date" id="fromDate" name="from" class="form-control" value="@(Model.From?.ToString("yyyy-MM-dd") ?? "")" />
            <input type="date" id="toDate" name="to" class="form-control" value="@(Model.To?.ToString("yyyy-MM-dd") ?? "")" />

            <button id="btn-search" type="submit" class="btn btn-primary">Search</button>
        </div>
    </form>

    <!-- Events Section -->
    <div id="events-section">
        <h3 class="section-title">Upcoming Events</h3>
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3" id="eventsContainer">
            @foreach (var ev in Model.Events)
            {
                <div class="col event-item" data-title="@ev.Title" data-category="@ev.Category" data-date="@ev.Date.ToString("yyyy-MM-dd")">
                    <div class="card card-event h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">@ev.Title</h5>
                            <p class="card-text">@ev.Description</p>
                        </div>
                        <div class="card-footer d-flex justify-content-between">
                            <small>@ev.Date.ToString("dd MMM yyyy")</small>
                            <span class="badge badge-category">@ev.Category</span>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Announcements Section -->
    <div id="announcements-section" style="display:none;">
        <h3 class="section-title">Announcements</h3>
        <div class="row row-cols-1 row-cols-md-2 g-3">
            @foreach (var ann in Model.Announcements)
            {
                <div class="col">
                    <div class="card card-announcement h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">@ann.Title</h5>
                            <p class="card-text">@ann.Message</p>
                        </div>
                        <div class="card-footer d-flex justify-content-between">
                            <small>@ann.DatePosted.ToString("dd MMM yyyy")</small>
                            <span class="badge badge-category">@ann.Category</span>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Recommendations Section (server-side persisted recommendations) -->
    <div id="recommendations-section" class="mt-4" style="@((Model.Recommendations == null || !Model.Recommendations.Any()) ? "display:none;" : "")">
        <h3 class="section-title">Recommended for you</h3>
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3" id="recommendationsContainer">
            @if (Model.Recommendations != null && Model.Recommendations.Any())
            {
                foreach (var rec in Model.Recommendations)
                {
                    <div class="col">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">@rec.Title</h5>
                                <p class="card-text">@rec.Description</p>
                            </div>
                            <div class="card-footer d-flex justify-content-between">
                                <small>@rec.Date.ToString("dd MMM yyyy")</small>
                                <span class="badge badge-category">@rec.Category</span>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12">
                    <p class="text-muted">No recommendations yet — try searching to build personalised suggestions.</p>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Toggle Events / Announcements buttons
            const btnEvents = document.getElementById('btn-events');
            const btnAnnouncements = document.getElementById('btn-announcements');
            const eventsSection = document.getElementById('events-section');
            const announcementsSection = document.getElementById('announcements-section');

            if (btnEvents && btnAnnouncements && eventsSection && announcementsSection) {
                btnEvents.addEventListener('click', (e) => {
                    e.preventDefault();
                    btnEvents.classList.add('active');
                    btnAnnouncements.classList.remove('active');
                    eventsSection.style.display = 'block';
                    announcementsSection.style.display = 'none';
                });

                btnAnnouncements.addEventListener('click', (e) => {
                    e.preventDefault();
                    btnAnnouncements.classList.add('active');
                    btnEvents.classList.remove('active');
                    eventsSection.style.display = 'none';
                    announcementsSection.style.display = 'block';
                });
            }

            // When the user submits the search form, persist the search term to server then perform the GET to refresh results.
            const searchForm = document.getElementById('searchForm');
            const antiForgeryForm = document.getElementById('antiForgeryForm');

            if (searchForm) {
                searchForm.addEventListener('submit', async function (e) {
                    e.preventDefault(); // we'll submit manually after persisting

                    // read the inputs to build POST and GET
                    const q = (document.getElementById('searchInput')?.value || '').trim();
                    const category = (document.getElementById('categorySelect')?.value || '').trim();
                    const from = (document.getElementById('fromDate')?.value || '').trim();
                    const to = (document.getElementById('toDate')?.value || '').trim();

                    // persist term to server (if non-empty)
                    if (q !== '') {
                        try {
                            // get antiforgery token from hidden form
                            const tokenInput = antiForgeryForm ? antiForgeryForm.querySelector('input[name="__RequestVerificationToken"]') : null;
                            const token = tokenInput ? tokenInput.value : null;

                            const headers = token ? { 'RequestVerificationToken': token } : {};
                            const body = new URLSearchParams();
                            body.append('term', q);

                            // POST to RecordSearch (fire-and-wait so server persists before reload)
                            await fetch('@Url.Action("RecordSearch", "Event")', {
                                method: 'POST',
                                headers,
                                body,
                                credentials: 'same-origin'
                            });
                        } catch (err) {
                            
                            console.warn('Could not persist search term:', err);
                        }
                    }

                    // Build query string for GET: use URLSearchParams to preserve values
                    const params = new URLSearchParams();
                    if (q) params.append('q', q);
                    if (category) params.append('category', category);
                    if (from) params.append('from', from);
                    if (to) params.append('to', to);

                    // navigate to the Load action with query string (this reloads page and controller will build Recommendations)
                    const url = '@Url.Action("Load", "Event")' + (params.toString() ? ('?' + params.toString()) : '');
                    window.location.href = url;
                });
            }
        });
    </script>
}